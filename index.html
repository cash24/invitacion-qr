
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Invitaci√≥n</title>
  <meta name="description" content="Invitaci√≥n con QR por par√°metros de URL (id, nombre, mesa, invitados)">
  <!-- Evita 404 del favicon en GitHub Pages -->
  data:,

  <style>
    :root{ --bg:#0b132b; --card:#1c2541; --txt:#ffffff; --acc:#5bc0be; }
    html,body{margin:0;padding:0;background:#0b132b;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--txt)}
    .wrap{max-width:780px;margin:0 auto;padding:24px}
    .card{background:var(--card);border-radius:16px;padding:20px 20px 24px;box-shadow:0 10px 30px rgba(0,0,0,.2)}
    h1{font-size:clamp(20px,4.5vw,28px);margin:.2em 0 .4em;line-height:1.2}
    .meta{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;margin:12px 0 18px}
    .item{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:12px}
    .label{font-size:12px;opacity:.85;letter-spacing:.3px;text-transform:uppercase}
    .value{font-weight:700;font-size:18px;margin-top:2px;word-break:break-word}
    .qr{display:flex;justify-content:center;align-items:center;padding:18px}
    .err{background:#3b0d0d;color:#ffe6e6;border:1px solid #ff7a7a;border-radius:10px;padding:12px;margin-top:12px}
    .ok{background:rgba(91,192,190,.12);border:1px solid rgba(91,192,190,.45);border-radius:10px;padding:10px;margin:10px 0 0}
    .small{font-size:12px;opacity:.9}
    @media (max-width:640px){ .meta{grid-template-columns:1fr 1fr} }
    @media (max-width:420px){ .meta{grid-template-columns:1fr} }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card" role="group" aria-label="Detalles de la invitaci√≥n">
    <h1>¬°Bienvenida/o a la fiesta!</h1>

    <div id="status" class="ok small" style="display:none"></div>

    <div class="meta">
      <div class="item">
        <div class="label">Nombre</div>
        <div id="nombre" class="value">‚Äî</div>
      </div>
      <div class="item">
        <div class="label">Mesa</div>
        <div id="mesa" class="value">‚Äî</div>
      </div>
      <div class="item">
        <div class="label">Invitados</div>
        <div id="invitados" class="value">‚Äî</div>
      </div>
    </div>

    <div class="meta" style="margin-top:0">
      <div class="item">
        <div class="label">ID</div>
        <div id="id" class="value">‚Äî</div>
      </div>
      <div class="item" style="grid-column: span 2;">
        <div class="label">Enlace de esta invitaci√≥n (para compartir)</div>
        <div id="link" class="value small" style="line-height:1.35;word-break:break-all">‚Äî</div>
      </div>
    </div>

    <div class="qr">
      <div id="qrcode" aria-label="C√≥digo QR de esta invitaci√≥n"></div>
    </div>

    <p class="small" style="opacity:.9">Muestra este QR en la entrada. Si lo abres desde el link, el c√≥digo se actualiza solo.</p>

    <div id="error" class="err" style="display:none"></div>
  </div>
</div>

<script>
/**
 * Cargador con fallbacks para qrcodejs.
 * Intenta 3 CDNs en orden. Llama a onReady() cuando window.QRCode est√© disponible.
 */
(function loadQRCodeLib(){
  const cdns = [
    // jsDelivr (npm)
    'https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js',
    // unpkg (npm)
    'https://unpkg.com/qrcodejs@1.0.0/qrcode.min.js',
    // cdnjs (Cloudflare) - nombre distinto del archivo
    'https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js'
  ];

  let idx = 0;
  function tryNext(){
    if (window.QRCode) {
      console.info('‚úÖ qrcodejs ya presente en la p√°gina.');
      onReady();
      return;
    }
    if (idx >= cdns.length) {
      const err = document.getElementById('error');
      err.style.display = 'block';
      err.textContent = 'No se pudo cargar la librer√≠a de QR desde los CDNs. Intenta recargar o av√≠same.';
      console.error('‚õî No fue posible cargar qrcodejs desde ninguno de los CDNs.');
      return;
    }
    const src = cdns[idx++];
    const s = document.createElement('script');
    s.src = src;
    s.async = true;
    s.onload = function(){
      if (window.QRCode) {
        console.info('‚úÖ qrcodejs cargado desde:', src);
        onReady();
      } else {
        console.warn('‚ö†Ô∏è Script cargado pero window.QRCode no est√° definido. Probando siguiente CDN‚Ä¶', src);
        tryNext();
      }
    };
    s.onerror = function(){
      console.warn('‚ö†Ô∏è Fall√≥ la carga del CDN:', src);
      tryNext();
    };
    document.head.appendChild(s);
  }
  tryNext();

  // ----- L√ìGICA PRINCIPAL: solo corre cuando la librer√≠a est√° lista -----
  function onReady(){
    console.groupCollapsed('%cInvitaci√≥n QR - Diagn√≥stico', 'background:#1c2541;color:#5bc0be;padding:2px 6px;border-radius:4px;');
    console.info('üëâ Versi√≥n:', '2026-01-20 1.1.0');
    console.info('location.href:', window.location.href);
    console.info('location.search (crudo):', window.location.search);
    console.info('document.referrer:', document.referrer);

    function normalizeQuery(search) {
      let s = search || '';
      if (s && s[0] !== '?' && s.includes('=')) s = '?' + s;
      const fixed = s.replace(/&amp;/g, '&');
      if (fixed !== s) {
        console.warn('‚ö†Ô∏è Normalizado &amp; ‚Üí & en query:', { original: s, fixed });
      }
      return fixed;
    }

    function parseParamsFrom(search) {
      const normalized = normalizeQuery(search);
      const p = new URLSearchParams(normalized);
      const clean = v => (v || '').replace(/^"(.*)"$/,'$1').trim();
      const data = {
        id: clean(p.get('id')),
        nombre: clean(p.get('nombre')),
        mesa: clean(p.get('mesa')),
        invitados: clean(p.get('invitados'))
      };
      console.table({ 'params parsed': data });
      return data;
    }

    function buildUrlFrom(base, data) {
      const qs = new URLSearchParams();
      if (data.id) qs.set('id', data.id);
      if (data.nombre) qs.set('nombre', data.nombre);
      if (data.mesa) qs.set('mesa', data.mesa);
      if (data.invitados) qs.set('invitados', data.invitados);
      return qs.toString() ? `${base}?${qs.toString()}` : base;
    }

    // Parseo
    let data = parseParamsFrom(window.location.search);

    // Pintar UI
    document.getElementById('id').textContent = data.id || '‚Äî';
    document.getElementById('nombre').textContent = data.nombre || '‚Äî';
    document.getElementById('mesa').textContent = data.mesa || '‚Äî';
    document.getElementById('invitados').textContent = data.invitados || '‚Äî';

    // Enlace a mostrar (siempre reconstruido con & reales)
    const base = window.location.origin + window.location.pathname;
    const finalUrl = buildUrlFrom(base, data);
    document.getElementById('link').textContent = finalUrl;
    console.info('üîó finalUrl mostrado:', finalUrl);

    // Validaci√≥n
    const missing = [];
    if(!data.id) missing.push('id');
    if(!data.nombre) missing.push('nombre');
    if(!data.mesa) missing.push('mesa');
    if(!data.invitados) missing.push('invitados');

    if(missing.length){
      const err = document.getElementById('error');
      err.style.display = 'block';
      err.innerHTML =
        'Faltan par√°metros obligatorios: <b>' + missing.join(', ') + '</b>.<br>' +
        'Ejemplo: ?id=1&nombre=MIKE&mesa=10&invitados=10';
      console.error('‚õî Faltan par√°metros:', missing);
      console.groupEnd();
      return;
    }

    // Generar QR
    try {
      new QRCode(document.getElementById('qrcode'), {
        text: finalUrl,
        width: 220,
        height: 220,
        colorDark : "#000000",
        colorLight : "#ffffff",
        correctLevel : QRCode.CorrectLevel.M
      });
      console.info('‚úÖ QR generado correctamente.');
    } catch(e) {
      const err = document.getElementById('error');
      err.style.display = 'block';
      err.textContent = 'No se pudo generar el QR. Revisa la consola.';
      console.error('‚ùå Error generando QR:', e);
      console.groupEnd();
      return;
    }

    // OK
    const ok = document.getElementById('status');
    ok.style.display = 'block';
    ok.textContent = 'Invitaci√≥n generada correctamente.';
    console.groupEnd();
  }
})();
</script>
</body>
</html>
